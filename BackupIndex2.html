<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>SATS Competition Board</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
<style>
  :root{
    --sats-primary:#009fdb;
    --sats-dark:#002b45;
    --bg:#ffffff;
    --bg-soft:#f5f7fa;
    --border:#e3e8ef;
    --text:#222;
    --muted:#667085;
  }
  html,body{height:100%; margin:0; font-family:"Helvetica Neue",Arial,sans-serif; background:var(--bg); color:var(--text);}
  body{display:grid; grid-template-columns:340px 1fr; height:100vh;}
  h1,h2,h3{margin:0; font-weight:700; color:var(--sats-dark);}
  h1{font-size:22px;} h2{font-size:18px;} h3{font-size:18px;}
  html{font-size:18px;}

  button,input{font:inherit;}
  .btn{cursor:pointer; border:none; border-radius:24px; padding:10px 18px; background:var(--sats-primary); color:#fff; font-weight:700;}
  .btn:hover{filter:brightness(0.95);}
  .btn.ghost{background:transparent; color:var(--sats-dark); border:1px solid var(--border);}
  .btn.small{padding:8px 12px; border-radius:20px; font-size:0.9rem;}

  input[type=date]{padding:4px 6px; font-size:0.9rem; border:1px solid #c9d2de; border-radius:6px; color:var(--text); background:#fff;}

  /* Sidebar */
  #sidebar{background:var(--bg-soft); border-right:1px solid var(--border); padding:16px; display:flex; flex-direction:column; gap:12px;}
  #competitions{flex:1; overflow:auto;}
  .competition{padding:10px 12px; margin:6px 0; border:1px solid var(--border); border-radius:12px; background:#fff; cursor:pointer;}
  .competition.active{background:var(--sats-primary); color:#fff; border-color:var(--sats-primary);}
  .competition.finished{background:#f0f0f0; color:#888; border:1px solid #ddd; font-style:italic;}

  /* Main */
  #main{padding:20px; overflow:auto; display:flex; flex-direction:column; gap:14px;}
  .row{display:flex; align-items:center; gap:10px; flex-wrap:wrap;}
  .spacer{flex:1;}
  .dates{color:var(--muted); gap:12px;}

  .grid-2{display:grid; gap:16px; grid-template-columns:1fr 1fr;}
  @media(max-width:1000px){body{grid-template-columns:1fr;} .grid-2{grid-template-columns:1fr;}}

  .card{background:#fff; border:1px solid var(--border); border-radius:14px; padding:14px;}
  table{width:100%; border-collapse:collapse;}
  thead th{padding:10px 8px; font-weight:700; color:var(--sats-dark); border-bottom:2px solid var(--border); background:#f0f8fc; text-align:left;}
  tbody td{padding:12px 8px; border-bottom:1px solid var(--border);}
  tbody tr:nth-child(odd){background:#fcfdff;}
  .scoreBtns{display:flex; gap:8px;}
  .btn.plus{flex:1; font-size:18px; padding:14px 20px; background:var(--sats-primary);}
  .btn.minus{background:#eef2f6; color:#333; padding:14px 16px;}

  /* Chart */
  #chartWrap{height:360px;}
  canvas{width:100%!important; height:100%!important;}

  /* Modal */
  #modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.45); z-index:10;}
  #modalContent{width:min(520px,92vw); background:#fff; border:1px solid var(--border); border-radius:14px; padding:16px; box-shadow:0 10px 28px rgba(0,0,0,.18);}
  .participantRow{display:flex; justify-content:space-between; padding:10px; margin:8px 0; border:1px solid var(--border); border-radius:10px; background:#fff;}
  .muted{color:var(--muted);}
</style>
</head>
<body>

<aside id="sidebar">
  <h2>Competitions</h2>
  <div id="competitions"></div>
  <button class="btn" id="btnNewComp">+ New competition</button>
  <button class="btn ghost" id="btnManage">Manage participants</button>
</aside>

<main id="main">
  <div class="row">
    <h1 id="compName">No competition</h1>
    <span class="spacer"></span>
    <button class="btn ghost" id="btnEnd">End now</button>
    <button class="btn" id="btnDraw">ðŸŽ‰ Draw winner</button>
  </div>
  <div class="row dates">
    ðŸ“… <input type="date" id="startDate"> <input type="date" id="endDate">
    <span class="muted" id="rangeInfo"></span>
  </div>

  <section class="grid-2">
    <div class="card">
      <h2>Leaderboard</h2>
      <table>
        <thead><tr><th>#</th><th>Name</th><th>Score</th><th>Action</th></tr></thead>
        <tbody id="leaderboard"></tbody>
      </table>
    </div>
    <div class="card">
      <div class="row" style="justify-content:space-between; margin-bottom:6px">
        <h2>Score development</h2>
        <div class="row">
          <button class="btn small ghost" id="rangeAll">All</button>
          <button class="btn small ghost" id="range30">30d</button>
          <button class="btn small ghost" id="range7">7d</button>
        </div>
      </div>
      <div id="chartWrap"><canvas id="chart"></canvas></div>
    </div>
  </section>
</main>

<div id="modal">
  <div id="modalContent">
    <div class="row" style="justify-content:space-between">
      <h3>Participants (global)</h3>
      <button class="btn ghost small" onclick="closeModal()">Close</button>
    </div>
    <p class="muted">Participants here appear in all competitions. Scores are per-competition.</p>
    <div id="partList"></div>
    <div class="row"><input id="newPart" placeholder="New participant name" style="flex:1"/><button class="btn" id="btnAddPart">Add</button></div>
  </div>
</div>

<script>
const STORAGE_KEY="sats-board-v6";
let state=JSON.parse(localStorage.getItem(STORAGE_KEY)||"{}");
if(!state.players) state.players={};
if(!state.competitions) state.competitions={};
if(!state.active) state.active=null;
function save(){localStorage.setItem(STORAGE_KEY,JSON.stringify(state));}
const active=()=>state.competitions[state.active];
function fmtShort(dateStr){const d=new Date(dateStr+"T00:00");const dd=String(d.getDate()).padStart(2,"0");const mm=String(d.getMonth()+1).padStart(2,"0");const yy=String(d.getFullYear()).slice(-2);return `${dd}/${mm}/${yy}`;}

/* Competitions */
function newComp(){
  const name=prompt("Competition name"); if(!name)return;
  const id=Date.now().toString(); const now=new Date();
  const start=now.toISOString().slice(0,10); const end=new Date(now.getTime()+30*86400000).toISOString().slice(0,10);
  state.competitions[id]={id,name,start,end,scores:{},events:[],ended:false};
  state.active=id; save(); render();
}
function switchComp(id){state.active=id; save(); render();}

/* Players */
function addPlayer(name){
  name=(name||"").trim(); if(!name)return;
  if(Object.values(state.players).some(p=>p.name.toLowerCase()===name.toLowerCase())){alert("Name exists");return;}
  const id=Math.random().toString(36).slice(2); state.players[id]={id,name}; save(); render();
}
function removePlayer(pid){delete state.players[pid]; Object.values(state.competitions).forEach(c=>delete c.scores[pid]); save(); render();}
function renamePlayer(pid){const p=state.players[pid]; if(!p)return; const n=prompt("New name:",p.name); if(!n)return; if(Object.values(state.players).some(x=>x.id!==pid&&x.name.toLowerCase()===n.toLowerCase())){alert("Name exists");return;} p.name=n; save(); render();}

/* Scoring */
function inc(pid){const c=active(); if(!c)return; c.scores[pid]=(c.scores[pid]||0)+1; c.events.push({pid,time:Date.now()}); save(); render();}
function dec(pid){const c=active(); if(!c)return; c.scores[pid]=Math.max(0,(c.scores[pid]||0)-1); save(); render();}

/* Winner */
function drawWinner(){const c=active(); if(!c)return; const entries=[]; for(const [pid,score] of Object.entries(c.scores)){for(let i=0;i<score;i++)entries.push(state.players[pid]?.name);} if(entries.length===0){alert("No points");return;} alert("Winner: "+entries[Math.floor(Math.random()*entries.length)]);}
function endNow(){const c=active(); if(!c)return; c.ended=true; c.end=new Date().toISOString().slice(0,10); save(); render();}

/* Sidebar */
function renderCompetitions(){const list=document.getElementById("competitions"); list.innerHTML=""; const comps=Object.values(state.competitions).sort((a,b)=>Number(b.id)-Number(a.id)); comps.forEach(c=>{const div=document.createElement("div"); div.className="competition"+(c.id===state.active?" active":"")+(c.ended?" finished":""); div.textContent=`${c.name} (${fmtShort(c.start)} â€“ ${fmtShort(c.end)})${c.ended?" (Finished)":""}`; div.onclick=()=>switchComp(c.id); list.appendChild(div);});}

/* Modal */
function openModal(){const pl=document.getElementById("partList"); pl.innerHTML=""; Object.values(state.players).sort((a,b)=>a.name.localeCompare(b.name)).forEach(p=>{const row=document.createElement("div"); row.className="participantRow"; row.innerHTML=`<div>${p.name}</div><div class="row"><button class="btn ghost small" onclick="renamePlayer('${p.id}')">Rename</button><button class="btn ghost small" onclick="removePlayer('${p.id}')">Remove</button></div>`; pl.appendChild(row);}); document.getElementById("modal").style.display="flex";}
function closeModal(){document.getElementById("modal").style.display="none";}

/* Chart */
let chart, chartRange="all"; const BRAND_COLORS=["#009fdb","#002b45","#56c271","#f4a261","#e76f51"];
function colorFor(pid,idx){if(idx<BRAND_COLORS.length)return BRAND_COLORS[idx]; let h=0; for(let i=0;i<pid.length;i++)h=(h*31+pid.charCodeAt(i))%360; return `hsl(${h} 55% 60%)`;}
function buildDateLabels(c){const arr=[]; let start=new Date(c.start+"T00:00"); let end=new Date(c.end+"T00:00"); if(chartRange==="30"){const d=new Date(end);d.setDate(d.getDate()-30); if(d>start) start=d;} if(chartRange==="7"){const d=new Date(end);d.setDate(d.getDate()-7); if(d>start) start=d;} for(let dt=new Date(start); dt<=end; dt.setDate(dt.getDate()+1)){arr.push(dt.toISOString().slice(0,10));} return arr;}

function buildChart(){
  const c=active(); if(!c) return;
  const ctx=document.getElementById("chart").getContext("2d");

  // Labels only up to today (or end date if earlier)
  const today = new Date();
  let labels = buildDateLabels(c).filter(d => new Date(d) <= today);

  const players = Object.values(state.players);
  const datasets = players.map((p,idx)=>{
    let score = 0;
    const data = labels.map(d=>{
      const dayEnd=new Date(d+"T23:59:59").getTime();
      score = c.events.filter(ev=>ev.pid===p.id && ev.time<=dayEnd).length;
      return score;
    });
    return {
      label:p.name,
      data,
      borderColor:colorFor(p.id,idx),
      borderWidth:2,
      tension:.25,
      pointRadius:0
    };
  });

  const maxScore = Math.max(1,...datasets.flatMap(ds=>ds.data));

  if(chart) chart.destroy();
  chart=new Chart(ctx,{
    type:"line",
    data:{ labels:labels.map(fmtShort), datasets },
    options:{
      maintainAspectRatio:false,
      scales:{
        x:{ ticks:{ maxTicksLimit:8 } },
        y:{
          beginAtZero:true,
          suggestedMax: maxScore+2, // always leave 2 above
        }
      }
    }
  });
}

/* Render */
function render(){renderCompetitions(); const c=active(); const nameEl=document.getElementById("compName"); const startEl=document.getElementById("startDate"); const endEl=document.getElementById("endDate"); const rangeInfo=document.getElementById("rangeInfo"); if(!c){nameEl.textContent="No competition"; startEl.value=endEl.value=""; document.getElementById("leaderboard").innerHTML=""; if(chart) chart.destroy(); return;} nameEl.textContent=c.name+(c.ended?" (Finished)":""); startEl.value=c.start; endEl.value=c.end; rangeInfo.textContent=`Showing: ${chartRange==='all'?'All days':chartRange+' days'} (${fmtShort(c.start)} â†’ ${fmtShort(c.end)})`; startEl.onchange=e=>{c.start=e.target.value; if(new Date(c.start)>new Date(c.end))c.end=c.start; save(); render();}; endEl.onchange=e=>{c.end=e.target.value; if(new Date(c.end)<new Date(c.start))c.start=c.end; save(); render();}; const tbody=document.getElementById("leaderboard"); tbody.innerHTML=""; Object.values(state.players).map(p=>({id:p.id,name:p.name,score:c.scores[p.id]||0})).sort((a,b)=>b.score-a.score||a.name.localeCompare(b.name)).forEach((p,i)=>{const tr=document.createElement("tr"); tr.innerHTML=`<td>${i+1}</td><td>${p.name}</td><td><b>${p.score}</b></td><td class="scoreBtns"><button class="btn plus" onclick="inc('${p.id}')">+1</button><button class="btn minus" onclick="dec('${p.id}')">-1</button></td>`; tbody.appendChild(tr);}); buildChart();}

/* Events */
document.getElementById("btnNewComp").onclick=newComp;
document.getElementById("btnManage").onclick=openModal;
document.getElementById("btnDraw").onclick=drawWinner;
document.getElementById("btnEnd").onclick=endNow;
document.getElementById("btnAddPart").onclick=()=>{const v=document.getElementById("newPart").value.trim(); if(v) addPlayer(v); document.getElementById("newPart").value="";};
document.getElementById("rangeAll").onclick=()=>{chartRange='all'; buildChart();};
document.getElementById("range30").onclick=()=>{chartRange='30'; buildChart();};
document.getElementById("range7").onclick=()=>{chartRange='7'; buildChart();};
render();
</script>
</body>
</html>